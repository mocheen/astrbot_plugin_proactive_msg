# AstrBot 主动消息插件

智能主动消息插件，可根据上下文和历史对话分析，主动发起有意义的对话，提高机器人交互的自然性和主动性。

## 功能特性

### 1. 智能时间感知
- 根据时间上下文判断是否发送主动消息的合适时机
- 检查AstrBot本体是否开启`datetime_system_prompt`配置
- 确保时间判断的准确性

### 2. 自定义轮询间隔
- 支持5分钟、10分钟、半小时、1小时、3小时等轮询周期
- 用户可根据需求灵活调整检查频率
- 避免频繁打扰用户

### 3. 灵活的消息阈值
- 可根据用户需求设置无消息时间阈值
- 支持1分钟、5分钟、10分钟、半小时、1小时等选项
- 只在用户长时间无消息时才触发主动检查

### 4. 多模式回复频率
- **稀少模式**：减少主动消息频率，适用于不希望打扰用户的场景
- **适中模式**：平衡的主动消息频率，适用于一般场景
- **频繁模式**：增加主动消息频率，适用于需要高互动的场景

### 5. 自动话题生成
- 基于LLM分析上下文，自动生成合适的主动话题
- 确保话题与当前对话相关或自然延伸
- 避免敏感或不适当的话题

## 技术实现

### 插件架构
- **主插件类**：继承自`Star`基类，实现插件生命周期管理
- **配置管理**：使用JSON格式存储配置，支持动态配置更新
- **调度器管理**：基于`AsyncIOScheduler`实现定时任务
- **消息分析器**：负责消息历史获取和LLM调用分析
- **提示词管理**：支持不同频率模式的提示词管理

### 核心流程
1. **插件初始化**：检查配置、初始化各组件、启动定时任务
2. **定时检查**：按配置间隔检查所有私聊会话
3. **消息分析**：获取消息历史，调用LLM判断是否发送主动消息
4. **话题生成**：如需发送，调用LLM生成合适的话题
5. **消息发送**：通过主机器人向用户发送主动消息

## 配置说明

### 主要配置项
- `poll_interval`：轮询间隔（5min/10min/30min/1hour/3hour）
- `no_message_threshold`：无消息时间阈值（1min/5min/10min/30min/1hour）
- `reply_frequency`：回复频率模式（rare/moderate/frequent）
- `enable_time_check`：启用时间感知检查（true/false）

### 配置文件路径
配置文件存储在 `data/config/proactive_msg_config.json`

## 安装和使用

### 安装步骤
1. 将插件文件夹放置在 `data/plugins/` 目录下
2. 确保AstrBot本体已安装并正常运行
3. 启用插件并通过WebUI进行配置

### 使用说明
1. 通过AstrBot WebUI进入插件管理页面
2. 找到"主动消息插件"并启用
3. 在插件配置页面调整相关参数
4. 保存配置，插件将自动开始工作

## 注意事项

1. **LLM依赖**：插件需要可用的LLM服务才能正常工作
2. **性能考虑**：轮询间隔不宜过短，避免影响系统性能
3. **消息历史**：确保消息存储正常，插件才能获取对话历史
4. **时间配置**：建议开启`datetime_system_prompt`以获得更好的时间判断效果

## 日志记录

插件会记录以下日志信息：
- 插件启动/停止日志
- 定时任务执行日志
- LLM调用和响应内容
- 主动消息发送日志
- 错误和异常信息

日志可通过AstrBot的统一日志系统查看。

## 版本信息

- **版本**：1.0.0
- **作者**：Claude
- **更新时间**：2025-01-29
- **依赖**：AstrBot 4.x+, Python 3.10+

## 支持

[帮助文档](https://astrbot.app)
